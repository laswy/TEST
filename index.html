<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C√îNG VI·ªÜC & GHI CH√ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="manifest" href="/manifest.json">
  
  <style>
    /* To√†n b·ªô m√£ CSS b·∫°n ƒë√£ cung c·∫•p s·∫Ω n·∫±m ·ªü ƒë√¢y */
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 10px; 
      margin: 0;
      transition: background-color 0.3s, color 0.3s; 
      background-color: #f8f9fa;
      color: #333;
    }
    body.dark-mode { 
      background-color: #1a1a1a; 
      color: #f4f4f4; 
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
    }
    
    .title {
      font-size: 1.5em;
      font-weight: bold;
      text-align: center;
      flex-grow: 1;
      margin: 0;
    }
    
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    body.dark-mode .nav-tabs {
      background: #2d2d2d;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .nav-tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      font-weight: 500;
      color: inherit;
    }
    
    .nav-tab.active {
      background: #007bff;
      color: white;
    }
    
    body.dark-mode .nav-tab.active {
      background: #ffc107;
      color: #000;
    }
    
    .dark-mode-toggle {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .dark-mode-toggle:hover {
      background: #0056b3;
    }
    
    body.dark-mode .dark-mode-toggle {
      background: #ffc107;
      color: #000;
    }
    
    body.dark-mode .dark-mode-toggle:hover {
      background: #e0a800;
    }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Form styling */
    .form-container {
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #007bff;
    }
    
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background-color: #333;
      color: #f4f4f4;
      border-color: #555;
    }
    
    body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
      border-color: #ffc107;
    }
    
    .add-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    
    .add-btn:hover {
      background: linear-gradient(135deg, #218838, #1ea887);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }
    
    /* File input styling */
    .file-input-container {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input {
      position: absolute;
      left: -9999px;
      opacity: 0;
      width: 1px;
      height: 1px;
    }
    
    .file-input-label {
      display: block;
      padding: 12px 15px;
      background: #6c757d;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .file-input-label:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    /* Notes specific styles */
    .notes-toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .toolbar-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      color: inherit;
      font-size: 14px;
    }
    
    .toolbar-btn:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }
    
    body.dark-mode .toolbar-btn {
      background: #2d2d2d;
      border-color: #555;
      color: #f4f4f4;
    }
    
    body.dark-mode .toolbar-btn:hover {
      background: #3d3d3d;
    }
    
    .rich-editor {
      min-height: 200px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
      outline: none;
      font-family: inherit;
      font-size: 16px;
      line-height: 1.5;
      overflow-y: auto;
      max-height: 400px;
    }
    
    .rich-editor:focus {
      border-color: #007bff;
    }
    
    body.dark-mode .rich-editor {
      background: #333;
      color: #f4f4f4;
      border-color: #555;
    }
    
    body.dark-mode .rich-editor:focus {
      border-color: #ffc107;
    }
    
    .rich-editor img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .rich-editor p {
      margin: 10px 0;
    }
    
    .rich-editor ul, .rich-editor ol {
      padding-left: 20px;
      margin: 10px 0;
    }
    
    /* Filter buttons */
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-buttons button {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      min-width: 100px;
    }
    
    .filter-buttons button:hover,
    .filter-buttons button.active {
      background: #007bff;
      color: white;
    }
    
    body.dark-mode .filter-buttons button {
      background: #1a1a1a;
      color: #ffc107;
      border-color: #ffc107;
    }
    
    body.dark-mode .filter-buttons button:hover,
    body.dark-mode .filter-buttons button.active {
      background: #ffc107;
      color: #000;
    }
    
    /* Search bar */
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-input {
      width: 100%;
      padding: 15px 45px 15px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: #666;
    }
    
    /* Task/Note list */
    .item-list { 
      list-style: none; 
      padding: 0; 
      margin: 0;
    }
    
    .item {
      padding: 15px;
      border: 2px solid #e9ecef;
      margin-bottom: 15px;
      border-radius: 12px;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }
    
    body.dark-mode .item { 
      border-color: #444; 
      background-color: #2d2d2d;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .item.pinned {
      border-color: #ffc107;
      background: linear-gradient(135deg, #fff9c4, #f8f9fa);
    }
    
    body.dark-mode .item.pinned {
      border-color: #ffc107;
      background: linear-gradient(135deg, #3d3300, #2d2d2d);
    }
    
    .pin-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #ffc107;
    }
    
    .item-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .item-content {
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .item-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .item-tags {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .tag {
      background: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    body.dark-mode .tag {
      background: #ffc107;
      color: #000;
    }
    
    .item-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    
    body.dark-mode .item-meta {
      color: #ccc;
    }
    
    .item-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .item-actions button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #000;
    }
    
    .btn-warning:hover {
      background: #e0a800;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
    }
    
    /* Progress bar for tasks */
    .progress-container { 
      margin: 10px 0; 
      height: 8px; 
      background: #e9ecef; 
      border-radius: 4px; 
      overflow: hidden;
    }
    
    body.dark-mode .progress-container { 
      background: #444; 
    }
    
    .progress-bar { 
      height: 100%; 
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 4px; 
      width: 0%; 
      transition: width 0.5s ease;
    }
    
    /* Task specific styles */
    .task-item.progress-white { background-color: #fff; }
    .task-item.progress-pink { background-color: #ffe0e0; }
    .task-item.progress-orange { background-color: #ffe5cc; }
    .task-item.progress-red { background-color: #ffcccc; }
    .task-item.completed-green { background-color: #e0ffe0; }
    
    body.dark-mode .task-item.progress-white { background-color: #2d2d2d; }
    body.dark-mode .task-item.progress-pink { background-color: #4d1f1f; }
    body.dark-mode .task-item.progress-orange { background-color: #4d3319; }
    body.dark-mode .task-item.progress-red { background-color: #4d1f1f; }
    body.dark-mode .task-item.completed-green { background-color: #1f4d1f; }
    
    .task-item.completed { opacity: 0.6; text-decoration: line-through; }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }
    
    body.dark-mode .modal-content {
      background-color: #2d2d2d;
      color: #f4f4f4;
    }
    
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }
    
    .close:hover {
      color: #000;
    }
    
    body.dark-mode .close {
      color: #ccc;
    }
    
    body.dark-mode .close:hover {
      color: #fff;
    }
    
    /* Stats */
    .stats-container { 
      margin-top: 20px; 
      padding: 15px; 
      background: white;
      border: 2px solid #e9ecef; 
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    body.dark-mode .stats-container { 
      background: #2d2d2d;
      border-color: #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    body.dark-mode .stat-item {
      background: #1a1a1a;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    
    body.dark-mode .stat-number {
      color: #ffc107;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    body.dark-mode .stat-label {
      color: #ccc;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.error {
      background: #dc3545;
    }
    
    .toast.warning {
      background: #ffc107;
      color: #000;
    }
    
    /* Image preview */
    .image-preview {
      margin-top: 10px;
      text-align: center;
    }
    
    .image-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .input-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .notes-toolbar {
        flex-direction: column;
      }
      
      .toolbar-btn {
        width: 100%;
      }
      
      .filter-buttons {
        flex-direction: column;
      }
      
      .filter-buttons button {
        width: 100%;
        margin-bottom: 8px;
      }
      
      .item-actions {
        flex-direction: column;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
    }
    
    /* Utility classes */
    .hidden {
      display: none !important;
    }
    
    .mt-10 {
      margin-top: 10px;
    }
    
    .mb-10 {
      margin-bottom: 10px;
    }
    
    .text-center {
      text-align: center;
    }
    
    .font-bold {
      font-weight: bold;
    }
    
    .text-sm {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="title">üìã C√îNG VI·ªÜC & GHI CH√ö</h1>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">‚òÄÔ∏è/üåô</button>
  </div>
  
<div class="header-tools" style="display:flex; gap:8px; align-items:center;">
  <button class="dark-mode-toggle" onclick="exportData()">‚¨áÔ∏è Xu·∫•t d·ªØ li·ªáu</button>
  <input id="importMergeInput" type="file" accept="application/json,.json" style="display:none" onchange="handleImportFile(this, 'merge')" />
  <input id="importOverwriteInput" type="file" accept="application/json,.json" style="display:none" onchange="handleImportFile(this, 'overwrite')" />
  <button class="dark-mode-toggle" onclick="document.getElementById('importMergeInput').click()">‚¨ÜÔ∏è Nh·∫≠p (g·ªôp)</button>
  <button class="dark-mode-toggle" onclick="document.getElementById('importOverwriteInput').click()">üßπ Nh·∫≠p (ghi ƒë√®)</button>
</div>

  
  
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('tasks')">üìã C√¥ng vi·ªác</button>
    <button class="nav-tab" onclick="switchTab('notes')">üìù Ghi ch√∫</button>
  </div>
  
  <div id="tasksTab" class="tab-content active">
    <div class="form-container">
      <div class="input-group">
        <input type="text" id="taskInput" placeholder="N·ªôi dung c√¥ng vi·ªác">
      </div>
      
      <div class="input-row">
        <input type="date" id="startTime" placeholder="Th·ªùi gian b·∫Øt ƒë·∫ßu">
        <input type="date" id="endTime" placeholder="Th·ªùi gian k·∫øt th√∫c">
        <select id="prioritySelect">
          <option value="low">Th·∫•p</option>
          <option value="medium" selected>Trung b√¨nh</option>
          <option value="high">Cao</option>
        </select>
      </div>
      
      <div class="input-row">
        <input type="text" id="taskTags" placeholder="Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
      </div>
      
      <button class="add-btn" onclick="addTask()">‚ûï TH√äM C√îNG VI·ªÜC</button>
    </div>
    
    <div class="search-container">
      <input type="text" class="search-input" id="taskSearch" placeholder="T√¨m ki·∫øm c√¥ng vi·ªác..." onkeyup="searchTasks()">
      <span class="search-icon">üîç</span>
    </div>
    
    <div class="filter-buttons">
      <button class="active" onclick="setTaskFilter('all')">T·∫•t c·∫£</button>
      <button onclick="setTaskFilter('active')">Ch∆∞a ho√†n th√†nh</button>
      <button onclick="setTaskFilter('completed')">ƒê√£ ho√†n th√†nh</button>
      <button onclick="setTaskFilter('pinned')">ƒê√£ ghim</button>
    </div>
    
    <ul id="taskList" class="item-list"></ul>
    
    <div class="stats-container">
      <h3>üìä TH·ªêNG K√ä C√îNG VI·ªÜC</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="totalTasks">0</div>
          <div class="stat-label">T·ªïng s·ªë</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="completedTasks">0</div>
          <div class="stat-label">Ho√†n th√†nh</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="activeTasks">0</div>
          <div class="stat-label">Ch∆∞a ho√†n th√†nh</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="pinnedTasks">0</div>
          <div class="stat-label">ƒê√£ ghim</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="notesTab" class="tab-content">
    <div class="form-container">
      <div class="input-group">
        <input type="text" id="noteTitle" placeholder="Ti√™u ƒë·ªÅ ghi ch√∫">
      </div>
      
      <div class="input-row">
        <input type="text" id="noteTags" placeholder="Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
      </div>
      
      <div class="notes-toolbar">
        <button class="toolbar-btn" onclick="formatText('bold')"><b>B</b></button>
        <button class="toolbar-btn" onclick="formatText('italic')"><i>I</i></button>
        <button class="toolbar-btn" onclick="formatText('underline')"><u>U</u></button>
        <button class="toolbar-btn" onclick="formatText('insertUnorderedList')">‚Ä¢ List</button>
        <button class="toolbar-btn" onclick="insertLink()">üîó Link</button>
        <button class="toolbar-btn" onclick="document.getElementById('imageInput').click()">üì∑ ·∫¢nh</button>
      </div>
      
      <div class="input-group">
        <div class="file-input-container">
          <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
          <label for="imageInput" class="file-input-label">üìÅ Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh</label>
        </div>
        <div id="imagePreview" class="image-preview"></div>
      </div>
      
      <div class="input-group">
        <div class="rich-editor" id="noteEditor" contenteditable="true" placeholder="Nh·∫≠p n·ªôi dung ghi ch√∫..."></div>
      </div>
      
      <button class="add-btn" onclick="addNote()">‚ûï TH√äM GHI CH√ö</button>
    </div>
    
    <div class="search-container">
      <input type="text" class="search-input" id="noteSearch" placeholder="T√¨m ki·∫øm ghi ch√∫..." onkeyup="searchNotes()">
      <span class="search-icon">üîç</span>
    </div>
    
    <div class="filter-buttons">
      <button class="active" onclick="setNoteFilter('all')">T·∫•t c·∫£</button>
      <button onclick="setNoteFilter('pinned')">ƒê√£ ghim</button>
      <button onclick="setNoteFilter('recent')">G·∫ßn ƒë√¢y</button>
    </div>
    
    <ul id="noteList" class="item-list"></ul>
    
    <div class="stats-container">
      <h3>üìä TH·ªêNG K√ä GHI CH√ö</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="totalNotes">0</div>
          <div class="stat-label">T·ªïng s·ªë</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="pinnedNotes">0</div>
          <div class="stat-label">ƒê√£ ghim</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="recentNotes">0</div>
          <div class="stat-label">G·∫ßn ƒë√¢y</div>
        </div>
      </div>
    </div>
  </div>

  <div id="editTaskModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditTaskModal()">&times;</span>
      <h2>‚úèÔ∏è S·ª≠a c√¥ng vi·ªác</h2>
      <div class="input-group">
        <input type="text" id="editTaskInput" placeholder="N·ªôi dung c√¥ng vi·ªác">
      </div>
      <div class="input-row">
        <input type="date" id="editStartTime">
        <input type="date" id="editEndTime">
        <select id="editPrioritySelect">
          <option value="low">Th·∫•p</option>
          <option value="medium">Trung b√¨nh</option>
          <option value="high">Cao</option>
        </select>
      </div>
      <div class="input-row">
        <input type="text" id="editTaskTags" placeholder="Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
      </div>
      <button class="add-btn" onclick="saveEditTask()">üíæ L∆ØU THAY ƒê·ªîI</button>
    </div>
  </div>

  <div id="editNoteModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditNoteModal()">&times;</span>
      <h2>‚úèÔ∏è S·ª≠a ghi ch√∫</h2>
      <div class="input-group">
        <input type="text" id="editNoteTitle" placeholder="Ti√™u ƒë·ªÅ ghi ch√∫">
      </div>
      <div class="input-row">
        <input type="text" id="editNoteTags" placeholder="Th·∫ª (c√°ch nhau b·ªüi d·∫•u ph·∫©y)">
      </div>
      <div class="input-group">
        <div class="rich-editor" id="editNoteEditor" contenteditable="true" placeholder="Nh·∫≠p n·ªôi dung ghi ch√∫..."></div>
      </div>
      <button class="add-btn" onclick="saveEditNote()">üíæ L∆ØU THAY ƒê·ªîI</button>
    </div>
  </div>

  <script>
// === Bi·∫øn to√†n c·ª•c ===
let tasks = [];
let notes = [];
let currentTaskFilter = 'all';
let currentNoteFilter = 'all';
let currentTab = 'tasks';
let editingTaskId = null; // Bi·∫øn ƒë·ªÉ l∆∞u ID c·ªßa c√¥ng vi·ªác ƒëang ch·ªânh s·ª≠a
let editingNoteId = null; // Bi·∫øn ƒë·ªÉ l∆∞u ID c·ªßa ghi ch√∫ ƒëang ch·ªânh s·ª≠a

// === Chuy·ªÉn tab ===
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');

  document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
  const clicked = document.querySelector(`.nav-tab[onclick="switchTab('${tab}')"]`);
  if (clicked) clicked.classList.add('active');
}

// === Dark Mode ===
function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkModeEnabled', isDark);
}

// === Th√¥ng b√°o ===
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// === L∆∞u / T·∫£i D·ªØ li·ªáu ===
function saveData() {
  try {
    const data = { tasks, notes, lastSaved: new Date().toISOString() };
    localStorage.setItem('todoAppData', JSON.stringify(data));
    showToast('ƒê√£ l∆∞u th√†nh c√¥ng!');
  } catch (err) {
    console.error(err);
    showToast('L·ªói khi l∆∞u d·ªØ li·ªáu!', 'error');
  }
}

function loadData() {
  try {
    const stored = JSON.parse(localStorage.getItem('todoAppData'));
    if (stored) {
      tasks = stored.tasks || [];
      notes = stored.notes || [];
    }
  } catch (err) {
    console.error(err);
    tasks = [];
    notes = [];
  }

  renderTasks();
  renderNotes();
  updateTaskStats();
  updateNoteStats();

  const dark = localStorage.getItem('darkModeEnabled');
  if (dark === 'true') document.body.classList.add('dark-mode');
}

// === C√¥ng vi·ªác ===
function addTask() {
  const text = document.getElementById('taskInput').value.trim();
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const priority = document.getElementById('prioritySelect').value;
  const tagsStr = document.getElementById('taskTags').value.trim();
  if (!text) return showToast('Vui l√≤ng nh·∫≠p n·ªôi dung c√¥ng vi·ªác!', 'error');

  const task = {
    id: Date.now(),
    text,
    start,
    end,
    priority,
    tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],
    completed: false,
    completedTime: null,
    pinned: false,
    createdAt: new Date().toISOString()
  };

  tasks.unshift(task);
  saveData();
  renderTasks();
  updateTaskStats();

  // Clear form fields
  document.getElementById('taskInput').value = '';
  document.getElementById('startTime').value = '';
  document.getElementById('endTime').value = '';
  document.getElementById('prioritySelect').value = 'medium';
  document.getElementById('taskTags').value = '';

  showToast('ƒê√£ th√™m c√¥ng vi·ªác!');
}

function renderTasks() {
  const list = document.getElementById('taskList');
  list.innerHTML = '';

  let filtered = tasks.filter(task => {
    if (currentTaskFilter === 'active') return !task.completed;
    if (currentTaskFilter === 'completed') return task.completed;
    if (currentTaskFilter === 'pinned') return task.pinned;
    return true;
  });

  const search = document.getElementById('taskSearch')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(t => t.text.toLowerCase().includes(search) || t.tags.some(tag => tag.toLowerCase().includes(search)));
  }

  filtered.sort((a, b) => b.pinned - a.pinned || new Date(b.createdAt) - new Date(a.createdAt));

  if (filtered.length === 0) {
    list.innerHTML = '<p class="text-center item-meta">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o.</p>';
    return;
  }

  for (const task of filtered) {
    const li = document.createElement('li');
    li.className = 'item task-item';
    if (task.completed) li.classList.add('completed');
    if (task.pinned) li.classList.add('pinned');

    const completedTimeHtml = task.completed && task.completedTime ? `<div class="item-meta" style="color: #28a745; font-weight: bold;">‚úÖ Ho√†n th√†nh: ${new Date(task.completedTime).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})} ${new Date(task.completedTime).toLocaleDateString('vi-VN')}</div>` : '';

    li.innerHTML = `
      ${task.pinned ? '<div class="pin-icon">üìå</div>' : ''}
      <div class="item-title">${task.text}</div>
      <div class="item-tags">${task.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
      <div class="item-meta">
        <strong>ƒê·ªô ∆∞u ti√™n:</strong> ${task.priority} | 
        <strong>B·∫Øt ƒë·∫ßu:</strong> ${task.start || 'Ch∆∞a ƒë·∫∑t'} | 
        <strong>K·∫øt th√∫c:</strong> ${task.end || 'Ch∆∞a ƒë·∫∑t'}
      </div>
      ${completedTimeHtml}
      <div class="item-actions">
        <button class="btn-info" onclick="openEditTaskModal(${task.id})">‚úèÔ∏è S·ª≠a</button>
        <button class="btn-success" onclick="toggleTaskComplete(${task.id})">${task.completed ? '‚Ü©Ô∏è Ho√†n t√°c' : '‚úÖ Ho√†n th√†nh'}</button>
        <button class="btn-warning" onclick="toggleTaskPin(${task.id})">${task.pinned ? 'üìå B·ªè ghim' : 'üìå Ghim'}</button>
        <button class="btn-danger" onclick="deleteTask(${task.id})">üóëÔ∏è X√≥a</button>
      </div>
    `;
    list.appendChild(li);
  }
}

function setTaskFilter(filter) {
  currentTaskFilter = filter;
  document.querySelectorAll('#tasksTab .filter-buttons button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`#tasksTab .filter-buttons button[onclick="setTaskFilter('${filter}')"]`).classList.add('active');
  renderTasks();
}

function searchTasks() {
  renderTasks();
}

function toggleTaskComplete(id) {
  const task = tasks.find(t => t.id === id);
  if (task) {
    task.completed = !task.completed;
    task.completedTime = task.completed ? new Date().toISOString() : null;
    saveData();
    renderTasks();
    updateTaskStats();
    showToast(task.completed ? 'ƒê√£ ho√†n th√†nh c√¥ng vi·ªác!' : 'ƒê√£ ho√†n t√°c c√¥ng vi·ªác!');
  }
}

function deleteTask(id) {
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?')) {
    tasks = tasks.filter(t => t.id !== id);
    saveData();
    renderTasks();
    updateTaskStats();
    showToast('ƒê√£ x√≥a c√¥ng vi·ªác!');
  }
}

function toggleTaskPin(id) {
  const task = tasks.find(t => t.id === id);
  if (task) {
    task.pinned = !task.pinned;
    saveData();
    renderTasks();
    updateTaskStats();
    showToast(task.pinned ? 'ƒê√£ ghim c√¥ng vi·ªác!' : 'ƒê√£ b·ªè ghim c√¥ng vi·ªác!');
  }
}

function updateTaskStats() {
  document.getElementById('totalTasks').textContent = tasks.length;
  document.getElementById('completedTasks').textContent = tasks.filter(t => t.completed).length;
  document.getElementById('activeTasks').textContent = tasks.filter(t => !t.completed).length;
  document.getElementById('pinnedTasks').textContent = tasks.filter(t => t.pinned).length;
}

// === Edit Task Modal Functions ===
function openEditTaskModal(id) {
  editingTaskId = id;
  const task = tasks.find(t => t.id === id);
  if (task) {
    document.getElementById('editTaskInput').value = task.text;
    document.getElementById('editStartTime').value = task.start;
    document.getElementById('editEndTime').value = task.end;
    document.getElementById('editPrioritySelect').value = task.priority;
    document.getElementById('editTaskTags').value = task.tags.join(', ');
    document.getElementById('editTaskModal').style.display = 'block';
  }
}

function closeEditTaskModal() {
  document.getElementById('editTaskModal').style.display = 'none';
  editingTaskId = null;
}

function saveEditTask() {
  const task = tasks.find(t => t.id === editingTaskId);
  if (task) {
    task.text = document.getElementById('editTaskInput').value.trim();
    task.start = document.getElementById('editStartTime').value;
    task.end = document.getElementById('editEndTime').value;
    task.priority = document.getElementById('editPrioritySelect').value;
    task.tags = document.getElementById('editTaskTags').value.trim().split(',').map(t => t.trim());
    saveData();
    renderTasks();
    updateTaskStats();
    showToast('ƒê√£ c·∫≠p nh·∫≠t c√¥ng vi·ªác!');
    closeEditTaskModal();
  }
}

// === Ghi ch√∫ ===
function addNote() {
  const title = document.getElementById('noteTitle').value.trim();
  const content = document.getElementById('noteEditor').innerHTML.trim();
  const tagsStr = document.getElementById('noteTags').value.trim();
  if (!title) return showToast('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ ghi ch√∫!', 'error');
  if (!content) return showToast('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫!', 'error');

  const note = {
    id: Date.now(),
    title,
    content,
    tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],
    pinned: false,
    createdAt: new Date().toISOString(),
    lastModified: new Date().toISOString()
  };

  notes.unshift(note);
  saveData();
  renderNotes();
  updateNoteStats();

  document.getElementById('noteTitle').value = '';
  document.getElementById('noteEditor').innerHTML = '';
  document.getElementById('noteTags').value = '';
  document.getElementById('imagePreview').innerHTML = ''; // Clear image preview

  showToast('ƒê√£ th√™m ghi ch√∫!');
}

function renderNotes() {
  const list = document.getElementById('noteList');
  list.innerHTML = '';

  let filtered = notes;

  const search = document.getElementById('noteSearch')?.value.toLowerCase();
  if (search) {
    filtered = filtered.filter(n => n.title.toLowerCase().includes(search) || n.content.toLowerCase().includes(search) || n.tags.some(tag => tag.toLowerCase().includes(search)));
  }

  filtered.sort((a, b) => {
    if (currentNoteFilter === 'pinned') return b.pinned - a.pinned;
    if (currentNoteFilter === 'recent') return new Date(b.lastModified) - new Date(a.lastModified);
    return new Date(b.createdAt) - new Date(a.createdAt);
  });

  if (filtered.length === 0) {
    list.innerHTML = '<p class="text-center item-meta">Kh√¥ng c√≥ ghi ch√∫ n√†o.</p>';
    return;
  }

  for (const note of filtered) {
    const li = document.createElement('li');
    li.className = 'item note-item';
    if (note.pinned) li.classList.add('pinned');

    li.innerHTML = `
      ${note.pinned ? '<div class="pin-icon">üìå</div>' : ''}
      <div class="item-title">${note.title}</div>
      <div class="item-content">${note.content}</div>
      <div class="item-tags">${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>
      <div class="item-meta">T·∫°o: ${new Date(note.createdAt).toLocaleDateString('vi-VN')} | C·∫≠p nh·∫≠t: ${new Date(note.lastModified).toLocaleDateString('vi-VN')}</div>
      <div class="item-actions">
        <button class="btn-info" onclick="openEditNoteModal(${note.id})">‚úèÔ∏è S·ª≠a</button>
        <button class="btn-warning" onclick="toggleNotePin(${note.id})">${note.pinned ? 'üìå B·ªè ghim' : 'üìå Ghim'}</button>
        <button class="btn-danger" onclick="deleteNote(${note.id})">üóëÔ∏è X√≥a</button>
      </div>
    `;
    list.appendChild(li);
  }
}

function setNoteFilter(filter) {
  currentNoteFilter = filter;
  document.querySelectorAll('#notesTab .filter-buttons button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`#notesTab .filter-buttons button[onclick="setNoteFilter('${filter}')"]`).classList.add('active');
  renderNotes();
}

function searchNotes() {
  renderNotes();
}

function deleteNote(id) {
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?')) {
    notes = notes.filter(n => n.id !== id);
    saveData();
    renderNotes();
    updateNoteStats();
    showToast('ƒê√£ x√≥a ghi ch√∫!');
  }
}

function toggleNotePin(id) {
  const note = notes.find(n => n.id === id);
  if (note) {
    note.pinned = !note.pinned;
    saveData();
    renderNotes();
    updateNoteStats();
    showToast(note.pinned ? 'ƒê√£ ghim ghi ch√∫!' : 'ƒê√£ b·ªè ghim ghi ch√∫!');
  }
}

function updateNoteStats() {
  document.getElementById('totalNotes').textContent = notes.length;
  document.getElementById('pinnedNotes').textContent = notes.filter(n => n.pinned).length;
  // For recent notes, let's define "recent" as created/modified in the last 7 days
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  document.getElementById('recentNotes').textContent = notes.filter(n => new Date(n.lastModified) >= sevenDaysAgo).length;
}

// === Rich Editor Functions ===
function formatText(command, value = null) {
  document.execCommand(command, false, value);
}

function insertLink() {
  const url = prompt('Nh·∫≠p URL:');
  if (url) {
    document.execCommand('createLink', false, url);
  }
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      document.getElementById('noteEditor').appendChild(img);
      document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" style="max-width: 100px; max-height: 100px;">`;
    };
    reader.readAsDataURL(file);
  }
}

// === Edit Note Modal Functions ===
function openEditNoteModal(id) {
  editingNoteId = id;
  const note = notes.find(n => n.id === id);
  if (note) {
    document.getElementById('editNoteTitle').value = note.title;
    document.getElementById('editNoteTags').value = note.tags.join(', ');
    document.getElementById('editNoteEditor').innerHTML = note.content;
    document.getElementById('editNoteModal').style.display = 'block';
  }
}

function closeEditNoteModal() {
  document.getElementById('editNoteModal').style.display = 'none';
  editingNoteId = null;
}

function saveEditNote() {
  const note = notes.find(n => n.id === editingNoteId);
  if (note) {
    note.title = document.getElementById('editNoteTitle').value.trim();
    note.tags = document.getElementById('editNoteTags').value.trim().split(',').map(t => t.trim());
    note.content = document.getElementById('editNoteEditor').innerHTML.trim();
    note.lastModified = new Date().toISOString();
    saveData();
    renderNotes();
    updateNoteStats();
    showToast('ƒê√£ c·∫≠p nh·∫≠t ghi ch√∫!');
    closeEditNoteModal();
  }
}

// === Initial Load ===
document.addEventListener('DOMContentLoaded', loadData);

// Close modals when clicking outside
window.onclick = function(event) {
  if (event.target == document.getElementById('editTaskModal')) {
    closeEditTaskModal();
  }
  if (event.target == document.getElementById('editNoteModal')) {
    closeEditNoteModal();
  }
}


// =====================
// = Export / Import   =
// =====================
function exportData() {
  try {
    const stored = localStorage.getItem('todoAppData');
    const obj = stored ? JSON.parse(stored) : { tasks, notes, lastSaved: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const now = new Date();
    const ts = now.toISOString().replace(/[:.]/g, '-');
    a.href = url;
    a.download = `congviec-ghichu-backup-${ts}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu ra file JSON!');
  } catch (e) {
    console.error(e);
    showToast('Xu·∫•t d·ªØ li·ªáu th·∫•t b·∫°i!', 'error');
  }
}

// mode: 'merge' | 'overwrite'
function handleImportFile(input, mode) {
  const file = input.files && input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const text = evt.target.result;
      importDataText(text, mode);
    } catch (e) {
      console.error(e);
      showToast('Kh√¥ng th·ªÉ ƒë·ªçc file!', 'error');
    } finally {
      input.value = ''; // reset
    }
  };
  reader.readAsText(file, 'utf-8');
}

function normalizeArray(arr, type) {
  if (!Array.isArray(arr)) return [];
  // Ensure minimal fields exist
  if (type === 'task') {
    return arr.map(t => ({
      id: t.id ?? Date.now() + Math.random(),
      text: String(t.text ?? ''),
      start: t.start ?? '',
      end: t.end ?? '',
      priority: t.priority ?? 'medium',
      tags: Array.isArray(t.tags) ? t.tags : [],
      completed: !!t.completed,
      completedTime: t.completed ? (t.completedTime ?? null) : null,
      pinned: !!t.pinned,
      createdAt: t.createdAt ?? new Date().toISOString()
    }));
  } else {
    return arr.map(n => ({
      id: n.id ?? Date.now() + Math.random(),
      title: String(n.title ?? ''),
      content: String(n.content ?? ''),
      tags: Array.isArray(n.tags) ? n.tags : [],
      pinned: !!n.pinned,
      createdAt: n.createdAt ?? new Date().toISOString(),
      lastModified: n.lastModified ?? new Date().toISOString()
    }));
  }
}

function importDataText(text, mode) {
  try {
    const obj = JSON.parse(text);
    const incomingTasks = normalizeArray(obj.tasks || [], 'task');
    const incomingNotes = normalizeArray(obj.notes || [], 'note');

    if (mode === 'overwrite') {
      tasks = incomingTasks;
      notes = incomingNotes;
      saveData();
      renderTasks();
      renderNotes();
      updateTaskStats();
      updateNoteStats();
      showToast('ƒê√£ nh·∫≠p (ghi ƒë√®) d·ªØ li·ªáu!');
      return;
    }

    // MERGE (default)
    const byId = (arr) => {
      const m = new Map();
      for (const it of arr) m.set(it.id, it);
      return m;
    };

    const taskMap = byId(tasks);
    const noteMap = byId(notes);

    for (const t of incomingTasks) {
      if (taskMap.has(t.id)) {
        // If both exist, keep the one with newer createdAt/completedTime presence
        const cur = taskMap.get(t.id);
        const curDate = new Date(cur.createdAt || 0);
        const incDate = new Date(t.createdAt || 0);
        if (incDate > curDate) {
          taskMap.set(t.id, t);
        }
      } else {
        taskMap.set(t.id, t);
      }
    }

    for (const n of incomingNotes) {
      if (noteMap.has(n.id)) {
        const cur = noteMap.get(n.id);
        const curDate = new Date(cur.lastModified || cur.createdAt || 0);
        const incDate = new Date(n.lastModified || n.createdAt || 0);
        if (incDate > curDate) {
          noteMap.set(n.id, n);
        }
      } else {
        noteMap.set(n.id, n);
      }
    }

    tasks = Array.from(taskMap.values()).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    notes = Array.from(noteMap.values()).sort((a,b) => new Date(b.lastModified||b.createdAt) - new Date(a.lastModified||a.createdAt));

    saveData();
    renderTasks();
    renderNotes();
    updateTaskStats();
    updateNoteStats();
    showToast('ƒê√£ nh·∫≠p (g·ªôp) d·ªØ li·ªáu!');
  } catch (e) {
    console.error(e);
    showToast('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON mong ƒë·ª£i!', 'error');
  }
}

</script>
</body>
</html>
